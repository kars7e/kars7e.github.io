<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<title> Creating vcards in rails using vpim - which works in outlook with correct encoding &middot; kars7e&#39;s Blog </title>


<link rel="stylesheet" href="http://blog.kars7e.io/css/slim.css">
<link rel="stylesheet" href="http://blog.kars7e.io/css/highlight.min.css">
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Source+Code+Pro' rel='stylesheet' type='text/css'>

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/favicon.ico">


<link href="" rel="alternate" type="application/rss+xml" title="kars7e&#39;s Blog" />

</head>

<body>
  <div class="container">
    <div class="header">
  <h1 class="site-title"><a href="http://blog.kars7e.io/">kars7e&#39;s Blog</a></h1>
  <p class="site-tagline"></p>
  <div class="nav">
    <a class="nav-btn" href="#">
      <span class="ci ci-burger"></span>
    </a>
    <ul class="nav-list">
       
	  <li class="spacer">&ac;</li>
  
    </ul>
  </div>
</div>
    <div class="content">
      <div class="posts">
        <div class="post">
          <h2 class="post-title"><a href="http://blog.kars7e.io/2013/09/12/creating-vcards-in-rails-using-vpim-which-works/">Creating vcards in rails using vpim - which works in outlook with correct encoding</a></h2>
          <span class="post-date">Sep 12, 2013 </span>
          <div class="post-content">
            <p>Short info - how to create vcards in rails, which work correctly in Outlook 20xx.
I’m using awsome vpim gem.
In controller, where you will generate vcard, add this require:</p>


require ''vpim/vcard''


<p>The best working solution is to encode your vcard in utf-8, which is not currently available in vpim, so lets add following piece of code (after the require):</p>


module Vpim
  class DirectoryInfo
    class Field
      class << self
        alias_method :orig_create, :create

        # we overwrite Field.create for setting the CHARSET
        def create(name, value='', params={})
          # specify the lines you don't want to add a charset to
          lines_to_ignore = %w(BEGIN END VERSION)
          params.merge!({'CHARSET' => 'utf-8'}) unless lines_to_ignore.include? name
          orig_create(name, value, params)
        end
      end

    end
  end
end


<p>It&rdquo;s important to set charset to utf-8, not UTF-8 - Outlook won’t handle it!
Now you have to generate vcard itself - i’m doing it with following piece of code:</p>


  #controller method
  def vcard
    person = Person.visible.find(params[:id])
    card = Vpim::Vcard::Maker.make2 do |maker|

      #setting up name
      maker.add_name do |name|
        name.prefix = ''
        name.given = person.first_name
        name.family = person.last_name
      end

      # setting up address.
      maker.add_addr do |addr|
        addr.location = 'work'
        addr.street = person.location.street
        addr.postalcode = person.location.zip_code
        addr.region = person.location.city
        addr.country = 'Poland'
      end

      maker.title = person.law_level
      maker.org = 'your company'
      maker.add_field(Vpim::DirectoryInfo::Field.create('office', person.location.name ))
      maker.add_tel(person.phone) { |e| e.location = 'cell'}
      maker.add_tel(person.location.phone) { |e| e.location = 'work'}


      maker.add_email(person.email) { |e| e.location = 'work' }

    end


<p>At the end, we have to send the file (still vcard method) :</p>

<p>
 send_data card.to_s, :type => ''text/x-vcard'', :filename => URI::encode(person.name) + ''.vcf''
  end
</p>

<p>Things to remember:
* Make correct charset
* set content-type (:type option) - you can sent charset also in content-type.
* URI:encode helps when filename includes non-ASCII characters</p>

          </div>
        </div>
        <div class="pagination">
          <a class="btn previous " href="http://blog.kars7e.io/2016/02/12/daj-sie-poznac-challange-accepted/"> Prev</a>  
          <a class="btn next " href="http://blog.kars7e.io/2013/06/23/i18ninvalidpluralizationdata-in-rails-32-with/"> Next</a> 
        </div>
      </div>
    </div>
    
    <div class="footer">
  
  <p>Powered by <a href="http://gohugo.io">Hugo</a>. This theme—Slim—is open sourced on <a href="https://github.com/zhe/hugo-theme-slim">Github</a>.</p>
  
</div>

  </div>
  <script src="http://blog.kars7e.io/js/slim.js"></script>
  <script src="http://blog.kars7e.io/js/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
  
</body>

</html>
