<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<title> Creating vcards in rails using vpim &middot; kars7e&#39;s Blog </title>


<link rel="stylesheet" href="http://blog.kars7e.io/css/slim.css">
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Source+Code+Pro' rel='stylesheet' type='text/css'>

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/favicon.ico">


<link href="" rel="alternate" type="application/rss+xml" title="kars7e&#39;s Blog" />

</head>

<body>
  <div class="container">
    <div class="header">
  <h1 class="site-title"><a href="http://blog.kars7e.io/">kars7e&#39;s Blog</a></h1>
  <p class="site-tagline">Personal blog of Karol Stepniewski</p>
  <div class="nav">
    <a class="nav-btn" href="#">
      <span class="ci ci-burger"></span>
    </a>
    <ul class="nav-list">
      
      <li><a href="/about/">About</a></li>
      
	    <li class="spacer">&ac;</li>
      <li><a href="https://github.com/kars7e" target="_blank">Github</a></li>
      <li><a href="https://twitter.com/kars7e" target="_blank">Twitter</a></li>
      <li><a href="http://linkedin.com/in/karolstepniewski" target="_blank">LinkedIn</a></li>
    </ul>
  </div>
</div>
    <div class="content">
      <div class="posts">
        <div class="post">
          <h2 class="post-title"><a href="http://blog.kars7e.io/2013/09/12/creating-vcards-in-rails-using-vpim-which-works/">Creating vcards in rails using vpim</a></h2>
          <span class="post-date">Sep 12, 2013 </span>
          <div class="post-content">
            <p>Short info - how to create vcards in rails, which work correctly in Outlook 20xx.</p>

<p>
I’m using awsome vpim gem.
In controller, where you will generate vcard, add this require:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #204a87">require</span> <span style="color: #4e9a06">&#39;&#39;</span><span style="color: #000000">vpim</span><span style="color: #ce5c00; font-weight: bold">/</span><span style="color: #000000">vcard</span><span style="color: #4e9a06">&#39;&#39;</span>
</pre></div>


<p>The best working solution is to encode your vcard in utf-8, which is not currently available in vpim, so lets add following piece of code (after the require):</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #204a87; font-weight: bold">module</span> <span style="color: #000000">Vpim</span>
  <span style="color: #204a87; font-weight: bold">class</span> <span style="color: #000000">DirectoryInfo</span>
    <span style="color: #204a87; font-weight: bold">class</span> <span style="color: #000000">Field</span>
      <span style="color: #204a87; font-weight: bold">class</span> <span style="color: #ce5c00; font-weight: bold">&lt;&lt;</span> <span style="color: #204a87">self</span>
        <span style="color: #000000">alias_method</span> <span style="color: #4e9a06">:orig_create</span><span style="color: #000000; font-weight: bold">,</span> <span style="color: #4e9a06">:create</span>

        <span style="color: #8f5902; font-style: italic"># we overwrite Field.create for setting the CHARSET</span>
        <span style="color: #204a87; font-weight: bold">def</span> <span style="color: #000000">create</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #204a87">name</span><span style="color: #000000; font-weight: bold">,</span> <span style="color: #000000">value</span><span style="color: #ce5c00; font-weight: bold">=</span><span style="color: #4e9a06">&#39;&#39;</span><span style="color: #000000; font-weight: bold">,</span> <span style="color: #000000">params</span><span style="color: #ce5c00; font-weight: bold">=</span><span style="color: #000000; font-weight: bold">{})</span>
          <span style="color: #8f5902; font-style: italic"># specify the lines you don&#39;t want to add a charset to</span>
          <span style="color: #000000">lines_to_ignore</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #4e9a06">%w(BEGIN END VERSION)</span>
          <span style="color: #000000">params</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">merge!</span><span style="color: #000000; font-weight: bold">({</span><span style="color: #4e9a06">&#39;CHARSET&#39;</span> <span style="color: #ce5c00; font-weight: bold">=&gt;</span> <span style="color: #4e9a06">&#39;utf-8&#39;</span><span style="color: #000000; font-weight: bold">})</span> <span style="color: #204a87; font-weight: bold">unless</span> <span style="color: #000000">lines_to_ignore</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">include?</span> <span style="color: #204a87">name</span>
          <span style="color: #000000">orig_create</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #204a87">name</span><span style="color: #000000; font-weight: bold">,</span> <span style="color: #000000">value</span><span style="color: #000000; font-weight: bold">,</span> <span style="color: #000000">params</span><span style="color: #000000; font-weight: bold">)</span>
        <span style="color: #204a87; font-weight: bold">end</span>
      <span style="color: #204a87; font-weight: bold">end</span>

    <span style="color: #204a87; font-weight: bold">end</span>
  <span style="color: #204a87; font-weight: bold">end</span>
<span style="color: #204a87; font-weight: bold">end</span>
</pre></div>


<p>It&rdquo;s important to set charset to utf-8, not UTF-8 - Outlook won’t handle it!
Now you have to generate vcard itself - i’m doing it with following piece of code:</p>

<p><div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>  <span style="color: #8f5902; font-style: italic">#controller method</span>
  <span style="color: #204a87; font-weight: bold">def</span> <span style="color: #000000">vcard</span>
    <span style="color: #000000">person</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #000000">Person</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">visible</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">find</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">params</span><span style="color: #ce5c00; font-weight: bold">[</span><span style="color: #4e9a06">:id</span><span style="color: #ce5c00; font-weight: bold">]</span><span style="color: #000000; font-weight: bold">)</span>
    <span style="color: #000000">card</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #000000">Vpim</span><span style="color: #ce5c00; font-weight: bold">::</span><span style="color: #000000">Vcard</span><span style="color: #ce5c00; font-weight: bold">::</span><span style="color: #000000">Maker</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">make2</span> <span style="color: #204a87; font-weight: bold">do</span> <span style="color: #ce5c00; font-weight: bold">|</span><span style="color: #000000">maker</span><span style="color: #ce5c00; font-weight: bold">|</span>

      <span style="color: #8f5902; font-style: italic">#setting up name</span>
      <span style="color: #000000">maker</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">add_name</span> <span style="color: #204a87; font-weight: bold">do</span> <span style="color: #ce5c00; font-weight: bold">|</span><span style="color: #204a87">name</span><span style="color: #ce5c00; font-weight: bold">|</span>
        <span style="color: #204a87">name</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">prefix</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #4e9a06">&#39;&#39;</span>
        <span style="color: #204a87">name</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">given</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #000000">person</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">first_name</span>
        <span style="color: #204a87">name</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">family</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #000000">person</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">last_name</span>
      <span style="color: #204a87; font-weight: bold">end</span>

      <span style="color: #8f5902; font-style: italic"># setting up address.</span>
      <span style="color: #000000">maker</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">add_addr</span> <span style="color: #204a87; font-weight: bold">do</span> <span style="color: #ce5c00; font-weight: bold">|</span><span style="color: #000000">addr</span><span style="color: #ce5c00; font-weight: bold">|</span>
        <span style="color: #000000">addr</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">location</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #4e9a06">&#39;work&#39;</span>
        <span style="color: #000000">addr</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">street</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #000000">person</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">location</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">street</span>
        <span style="color: #000000">addr</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">postalcode</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #000000">person</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">location</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">zip_code</span>
        <span style="color: #000000">addr</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">region</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #000000">person</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">location</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">city</span>
        <span style="color: #000000">addr</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">country</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #4e9a06">&#39;Poland&#39;</span>
      <span style="color: #204a87; font-weight: bold">end</span>

      <span style="color: #000000">maker</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">title</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #000000">person</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">law_level</span>
      <span style="color: #000000">maker</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">org</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #4e9a06">&#39;your company&#39;</span>
      <span style="color: #000000">maker</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">add_field</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">Vpim</span><span style="color: #ce5c00; font-weight: bold">::</span><span style="color: #000000">DirectoryInfo</span><span style="color: #ce5c00; font-weight: bold">::</span><span style="color: #000000">Field</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">create</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #4e9a06">&#39;office&#39;</span><span style="color: #000000; font-weight: bold">,</span> <span style="color: #000000">person</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">location</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">name</span> <span style="color: #000000; font-weight: bold">))</span>
      <span style="color: #000000">maker</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">add_tel</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">person</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">phone</span><span style="color: #000000; font-weight: bold">)</span> <span style="color: #000000; font-weight: bold">{</span> <span style="color: #ce5c00; font-weight: bold">|</span><span style="color: #000000">e</span><span style="color: #ce5c00; font-weight: bold">|</span> <span style="color: #000000">e</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">location</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #4e9a06">&#39;cell&#39;</span><span style="color: #000000; font-weight: bold">}</span>
      <span style="color: #000000">maker</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">add_tel</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">person</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">location</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">phone</span><span style="color: #000000; font-weight: bold">)</span> <span style="color: #000000; font-weight: bold">{</span> <span style="color: #ce5c00; font-weight: bold">|</span><span style="color: #000000">e</span><span style="color: #ce5c00; font-weight: bold">|</span> <span style="color: #000000">e</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">location</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #4e9a06">&#39;work&#39;</span><span style="color: #000000; font-weight: bold">}</span>


      <span style="color: #000000">maker</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">add_email</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">person</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">email</span><span style="color: #000000; font-weight: bold">)</span> <span style="color: #000000; font-weight: bold">{</span> <span style="color: #ce5c00; font-weight: bold">|</span><span style="color: #000000">e</span><span style="color: #ce5c00; font-weight: bold">|</span> <span style="color: #000000">e</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">location</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #4e9a06">&#39;work&#39;</span> <span style="color: #000000; font-weight: bold">}</span>

    <span style="color: #204a87; font-weight: bold">end</span>
</pre></div>
</p>

<p>At the end, we have to send the file (still vcard method) :</p>

<p><div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span> <span style="color: #000000">send_data</span> <span style="color: #000000">card</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">to_s</span><span style="color: #000000; font-weight: bold">,</span> <span style="color: #4e9a06">:type</span> <span style="color: #ce5c00; font-weight: bold">=&gt;</span> <span style="color: #4e9a06">&#39;&#39;</span><span style="color: #000000">text</span><span style="color: #ce5c00; font-weight: bold">/</span><span style="color: #000000">x</span><span style="color: #ce5c00; font-weight: bold">-</span><span style="color: #000000">vcard</span><span style="color: #4e9a06">&#39;&#39;</span><span style="color: #000000; font-weight: bold">,</span> <span style="color: #4e9a06">:filename</span> <span style="color: #ce5c00; font-weight: bold">=&gt;</span> <span style="color: #000000">URI</span><span style="color: #ce5c00; font-weight: bold">::</span><span style="color: #000000">encode</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">person</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">name</span><span style="color: #000000; font-weight: bold">)</span> <span style="color: #ce5c00; font-weight: bold">+</span> <span style="color: #4e9a06">&#39;&#39;</span><span style="color: #ce5c00; font-weight: bold">.</span><span style="color: #000000">vcf</span><span style="color: #4e9a06">&#39;&#39;</span>
  <span style="color: #204a87; font-weight: bold">end</span>
</pre></div>
</p>

<p>Things to remember:
* Make correct charset
* set content-type (:type option) - you can sent charset also in content-type.
* URI:encode helps when filename includes non-ASCII characters</p>
          </div>
        </div>
        <div class="pagination">
          <a class="btn previous " href="http://blog.kars7e.io/2016/02/12/daj-sie-poznac-challange-accepted/"> Prev</a>  
          <a class="btn next " href="http://blog.kars7e.io/2013/06/23/i18ninvalidpluralizationdata-in-rails-32-with/"> Next</a> 
        </div>
      </div>
    </div>
    
    <div class="footer">
  <p>2017 Karol Stepniewski</p>
</div>

  </div>
  <script src="http://blog.kars7e.io/js/slim.js"></script>
  <script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-7878188-6', 'auto');
ga('send', 'pageview');

</script>

</body>

</html>
